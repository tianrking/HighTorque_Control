# LivelyBot Motor Control - Rust Makefile
# é«˜æ€§èƒ½ Rust ç”µæœºæ§åˆ¶ç¼–è¯‘è„šæœ¬

# Rust ç¯å¢ƒå˜é‡
export CARGO_TARGET_DIR ?= target
export RUSTFLAGS ?= -C target-cpu=native

# é»˜è®¤ç›®æ ‡
.PHONY: all clean help install test release debug

all: release

# å‘å¸ƒæ¨¡å¼ç¼–è¯‘ (ä¼˜åŒ–)
release:
	@echo "ğŸš€ ç¼–è¯‘ Rust å‘å¸ƒç‰ˆæœ¬..."
	cargo build --release
	@echo "âœ… å‘å¸ƒç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"
	@echo "å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®:"
	@echo "  - ./target/release/can_motor_scanner"
	@echo "  - ./target/release/velocity_acceleration_control"
	@echo "  - ./target/release/angle_stream_control"

# å¼€å‘æ¨¡å¼ç¼–è¯‘ (å¿«é€Ÿ)
debug:
	@echo "ğŸ”§ ç¼–è¯‘ Rust å¼€å‘ç‰ˆæœ¬..."
	cargo build
	@echo "âœ… å¼€å‘ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

# æ£€æŸ¥ä»£ç 
check:
	@echo "ğŸ” æ£€æŸ¥ä»£ç ..."
	cargo check
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# ä»£ç æ£€æŸ¥ (Clippy)
clippy:
	@echo "ğŸ” è¿è¡Œ Clippy..."
	cargo clippy -- -D warnings
	@echo "âœ… Clippy æ£€æŸ¥å®Œæˆ"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	cargo fmt
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	cargo test
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	cargo clean
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…åˆ°ç³»ç»Ÿç›®å½•
install: release
	@echo "ğŸ“¦ å®‰è£…åˆ°ç³»ç»Ÿç›®å½•..."
	sudo cp target/release/can_motor_scanner /usr/local/bin/
	sudo cp target/release/velocity_acceleration_control /usr/local/bin/
	sudo cp target/release/angle_stream_control /usr/local/bin/
	@echo "âœ… å®‰è£…å®Œæˆï¼ç°åœ¨å¯ä»¥åœ¨ä»»ä½•ç›®å½•è¿è¡Œè¿™äº›ç¨‹åº"

# å¸è½½
uninstall:
	@echo "ğŸ—‘ï¸  ä»ç³»ç»Ÿç›®å½•å¸è½½..."
	sudo rm -f /usr/local/bin/can_motor_scanner
	sudo rm -f /usr/local/bin/velocity_acceleration_control
	sudo rm -f /usr/local/bin/angle_stream_control
	@echo "âœ… å¸è½½å®Œæˆ"

# æ£€æŸ¥ Rust ç¯å¢ƒ
check-deps:
	@echo "ğŸ”§ æ£€æŸ¥ Rust ç¯å¢ƒ..."
	@which cargo > /dev/null || (echo "âŒ éœ€è¦å®‰è£… Rust: https://rustup.rs/" && exit 1)
	@cargo --version
	@rustc --version
	@echo "âœ… Rust ç¯å¢ƒæ£€æŸ¥å®Œæˆ"

# å¿«é€Ÿæµ‹è¯•ç¼–è¯‘
quick-test: release
	@echo "ğŸ§ª å¿«é€Ÿæµ‹è¯•ç¼–è¯‘ç»“æœ..."
	@echo "æµ‹è¯• can_motor_scanner --help..."
	./target/release/can_motor_scanner --help || echo "æ‰«æå™¨å¸®åŠ©æµ‹è¯•"
	@echo "æµ‹è¯• velocity_acceleration_control --help..."
	./target/release/velocity_acceleration_control --help || echo "é€Ÿåº¦æ§åˆ¶å¸®åŠ©æµ‹è¯•"
	@echo "æµ‹è¯• angle_stream_control --help..."
	./target/release/angle_stream_control --help || echo "è§’åº¦æ§åˆ¶å¸®åŠ©æµ‹è¯•"
	@echo "âœ… æ‰€æœ‰ç¨‹åºç¼–è¯‘æ­£å¸¸"

# æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "LivelyBot ç”µæœºæ§åˆ¶ Rust ç¼–è¯‘è„šæœ¬"
	@echo "==================================="
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make           - ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬ (é»˜è®¤)"
	@echo "  make debug     - ç¼–è¯‘å¼€å‘ç‰ˆæœ¬"
	@echo "  make release   - ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬ (ä¼˜åŒ–)"
	@echo "  make check     - æ£€æŸ¥ä»£ç "
	@echo "  make clippy    - è¿è¡Œ Clippy"
	@echo "  make fmt       - æ ¼å¼åŒ–ä»£ç "
	@echo "  make test      - è¿è¡Œæµ‹è¯•"
	@echo "  make clean     - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make install   - å®‰è£…åˆ°ç³»ç»Ÿç›®å½•"
	@echo "  make uninstall - ä»ç³»ç»Ÿç›®å½•å¸è½½"
	@echo "  make check-deps - æ£€æŸ¥ Rust ç¯å¢ƒ"
	@echo "  make quick-test - å¿«é€Ÿæµ‹è¯•ç¼–è¯‘ç»“æœ"
	@echo "  make help      - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make && make install              # ç¼–è¯‘å¹¶å®‰è£…"
	@echo "  make debug                         # å¼€å‘æ¨¡å¼ç¼–è¯‘"
	@echo "  make clean && make release         # æ¸…ç†åé‡æ–°ç¼–è¯‘"
	@echo ""
	@echo "ä¾èµ–æ£€æŸ¥:"
	@echo "  éœ€è¦: Rust 1.70+, socketcan-dev"
	@echo ""
	@echo "ç¨‹åºä½ç½®:"
	@echo "  ./target/release/can_motor_scanner"
	@echo "  ./target/release/velocity_acceleration_control"
	@echo "  ./target/release/angle_stream_control"